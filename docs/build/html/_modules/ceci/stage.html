

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ceci.stage &mdash; TXPipe  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> TXPipe
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">TXPipe Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stages.html">Stages implemented in TX-Pipe:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../submodules.html">Submodules for TXPipe</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">TXPipe</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>ceci.stage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ceci.stage</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">cProfile</span>

<span class="n">SERIAL</span> <span class="o">=</span> <span class="s2">&quot;serial&quot;</span>
<span class="n">MPI_PARALLEL</span> <span class="o">=</span> <span class="s2">&quot;mpi&quot;</span>

<span class="n">IN_PROGRESS_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;inprogress_&quot;</span>


<span class="k">class</span> <span class="nc">PipelineStage</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A PipelineStage implements a single calculation step within a wider pipeline.</span>

<span class="sd">    Each different type of analysis stge is represented by a subclass of this</span>
<span class="sd">    base class.  The base class handles the connection between different pipeline</span>
<span class="sd">    stages, and the execution of the stages within a workflow system (parsl),</span>
<span class="sd">    potentially in parallel (MPI).</span>

<span class="sd">    An instance of one of these classes represents an actual run of the stage,</span>
<span class="sd">    with the required inputs, outputs, and configuration specified.</span>

<span class="sd">    See documentation pages for more details.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">parallel</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">config_options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="PipelineStage.__init__"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a pipeline stage, specifying the inputs, outputs, and configuration for it.</span>

<span class="sd">        The constructor needs a dict or namespace. It should include:</span>
<span class="sd">        - input paths (required)</span>
<span class="sd">        - config path (required)</span>
<span class="sd">        - output paths (optional but usual)</span>
<span class="sd">        - additional configuration (required if not specified elsewhere)</span>

<span class="sd">        Input and output paths should map tags to paths.</span>
<span class="sd">        Tags are strings, and the first elements in each item in the subclass&#39;s</span>
<span class="sd">        &quot;inputs&quot; and &quot;output&quot; attributes.</span>
<span class="sd">        e.g. for a subclass with:</span>
<span class="sd">            inputs = [(&#39;eggs&#39;, TextFile)]</span>
<span class="sd">            outputs = [(&#39;spam&#39;, TextFile)]</span>
<span class="sd">        the args could contain:</span>
<span class="sd">            {&#39;eggs&#39;: &#39;inputs/eggs.txt&#39;, </span>
<span class="sd">             &#39;spam&#39;: &#39;outputs/spam.txt&#39; }</span>
<span class="sd">        If spam is not specified it will default to &quot;./spam.txt&quot;</span>

<span class="sd">        }</span>
<span class="sd">        </span>
<span class="sd">        The config should map &quot;config&quot; to a path where a YAML config file</span>
<span class="sd">        is located, e.g. {&#39;config&#39;:&#39;/path/to/config.yml&#39;}</span>

<span class="sd">        Any config variables that are specified in the class&#39;s config attribute</span>
<span class="sd">        will be searched for first in args, then in the config file, and then</span>
<span class="sd">        by looking at any default value they have been given.</span>
<span class="sd">        If they have no default value (and just a type, like int, is listed), then</span>
<span class="sd">        it&#39;s an error if they are not specified somewhere.</span>

<span class="sd">        The execute method can instantiate and run the class together, with added bonuses</span>
<span class="sd">        like profiling and debugging tools.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        args: dict or namespace</span>
<span class="sd">            Specification of input and output paths and any missing config options</span>
<span class="sd">        comm: MPI communicator</span>
<span class="sd">            (default is None) An MPI comm object to use in preference to COMM_WORLD</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># We first check for missing input files, that&#39;s a show stopper</span>
        <span class="n">missing_inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_tags</span><span class="p">():</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">missing_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_inputs</span><span class="p">:</span>
            <span class="n">missing_inputs</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_inputs</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">Missing these names on the command line:</span>
<span class="s2">    Input names: </span><span class="si">{</span><span class="n">missing_inputs</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">args</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_tags</span><span class="p">()}</span>
        <span class="c1"># We alwys assume the config arg exists, whether it is in input_tags or not</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The argument --config was missing on the command line.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>

        <span class="c1"># We prefer to receive explicit filenames for the outputs but will</span>
        <span class="c1"># tolerate missing output filenames and will default to tag name in</span>
        <span class="c1"># current folder (this is for CWL compliance)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_tags</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ftype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">ftype</span><span class="o">.</span><span class="n">make_name</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>

        <span class="c1"># Finally, we extract configuration information from a combination of</span>
        <span class="c1"># command line arguments and optional &#39;config&#39; file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_config</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="n">use_mpi</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mpi&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_mpi</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># This isn&#39;t a ceci dependency, so give a sensible error message if not installed.</span>
                <span class="kn">import</span> <span class="nn">mpi4py.MPI</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: Using --mpi option requires mpi4py to be installed.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="c1"># For scripting and testing we allow an MPI communicator or anything</span>
        <span class="c1"># with the same API to be passed in directly, overriding the --mpi</span>
        <span class="c1"># flag.</span>
        <span class="k">if</span> <span class="n">comm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parallel</span> <span class="o">=</span> <span class="n">MPI_PARALLEL</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span> <span class="o">=</span> <span class="n">comm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">use_mpi</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parallel</span> <span class="o">=</span> <span class="n">MPI_PARALLEL</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span> <span class="o">=</span> <span class="n">mpi4py</span><span class="o">.</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parallel</span> <span class="o">=</span> <span class="n">SERIAL</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rank</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="n">pipeline_stages</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="PipelineStage.__init_subclass__"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.__init_subclass__">[docs]</a>    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Python 3.6+ provides a facility to automatically</span>
<span class="sd">        call a method (this one) whenever a new subclass</span>
<span class="sd">        is defined.  In this case we use that feature to keep</span>
<span class="sd">        track of all available pipeline stages, each of which is</span>
<span class="sd">        defined by a class.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># This is a hacky way of finding the file</span>
        <span class="c1"># where our stage was defined</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span><span class="o">.</span><span class="vm">__file__</span>

        <span class="c1"># Make sure the pipeline stage has a name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Pipeline stage defined in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> must be given a name.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Pipeline stage </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> defined in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> must be given a list of outputs.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Pipeline stage </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> defined in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> must be given a list of inputs.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check for two stages with the same name.</span>
        <span class="c1"># Not sure if we actually do want to allow this?</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">pipeline_stages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pipeline stage </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> already defined&quot;</span><span class="p">)</span>

        <span class="c1"># Check for &quot;config&quot; in the inputs list - this is now implicit</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;config&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;An input called &#39;config&#39; is now implicit in each pipeline stage</span>
<span class="s2">and should not be added explicitly.  Please update your pipeline stage called </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to remove</span>
<span class="s2">the input called &#39;config&#39;.</span>
<span class="s2">&quot;&quot;&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Find the absolute path to the class defining the file</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">pipeline_stages</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>

    <span class="c1">#############################################</span>
    <span class="c1"># Life cycle-related methods and properties.</span>
    <span class="c1">#############################################</span>

<div class="viewcode-block" id="PipelineStage.get_stage"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.get_stage">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_stage</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the PipelineStage subclass with the given name.</span>

<span class="sd">        This is used so that we do not need a new entry point __main__ function</span>
<span class="sd">        for each new stage - instead we can just use a single one which can query</span>
<span class="sd">        which class it should be using based on the name.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cls: class</span>
<span class="sd">            The corresponding subclass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">pipeline_stages</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="PipelineStage.get_module"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.get_module">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_module</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the path to the python package containing the current sub-class</span>

<span class="sd">        If we have a PipelineStage subclass defined in a module called &quot;bar&quot;, in </span>
<span class="sd">        a package called &quot;foo&quot; e.g.:</span>
<span class="sd">        /path/to/foo/bar.py  &lt;--   contains subclass &quot;Baz&quot;</span>

<span class="sd">        Then calling Baz.get_module() will return &quot;foo.bar&quot;.</span>

<span class="sd">        We use this later to construct command lines like &quot;python -m foo Baz&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        module: str</span>
<span class="sd">            The module containing this class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">pipeline_stages</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__module__</span></div>

<div class="viewcode-block" id="PipelineStage.usage"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.usage">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">usage</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print a usage message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stage_names</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">- &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">pipeline_stages</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_module</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="s2">&quot;&lt;module_name&gt;&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Usage: python -m </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> &lt;stage_name&gt; &lt;stage_arguments&gt;</span>

<span class="s2">If no stage_arguments are given then usage information</span>
<span class="s2">for the chosen stage will be given.</span>

<span class="s2">I currently know about these stages:</span>
<span class="s2">- </span><span class="si">{</span><span class="n">stage_names</span><span class="si">}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="PipelineStage.main"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.main">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instance of this stage and execute it with</span>
<span class="sd">        inputs and outputs taken from the command line</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stage_name</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">usage</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">stage_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;--help&quot;</span><span class="p">,</span> <span class="s2">&quot;-h&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">usage</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="n">stage</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_stage</span><span class="p">(</span><span class="n">stage_name</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">_parse_command_line</span><span class="p">()</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_parse_command_line</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[:])</span>
        <span class="kn">import</span> <span class="nn">argparse</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Run pipeline stage </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;stage_name&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">config_options</span><span class="p">:</span>
            <span class="n">def_val</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">config_options</span><span class="p">[</span><span class="n">conf</span><span class="p">]</span>
            <span class="n">opt_type</span> <span class="o">=</span> <span class="n">def_val</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">def_val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span> <span class="k">else</span> <span class="nb">type</span><span class="p">(</span><span class="n">def_val</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">opt_type</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">opt_type</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">out_type</span> <span class="o">=</span> <span class="n">def_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">def_val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">type</span> <span class="k">else</span> <span class="nb">type</span><span class="p">(</span><span class="n">def_val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">out_type</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">string</span><span class="p">:</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">out_type</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">string</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)],</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">out_type</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">string</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)],</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="s2">&quot;Only handles str, int and float list arguments&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">opt_type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">input_tags</span><span class="p">():</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">inp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">output_tags</span><span class="p">():</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--config&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--mpi&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set up MPI parallelism&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--pdb&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run under the python debugger&quot;</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--cprofile&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Profile the stage using the python cProfile tool&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">args</span>

<div class="viewcode-block" id="PipelineStage.execute"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.execute">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instance of this stage and run it</span>
<span class="sd">        with the specified inputs and outputs.</span>

<span class="sd">        This is calld by the main method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        args: namespace</span>
<span class="sd">            The argparse namespace for this subclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pdb</span>

        <span class="n">stage</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing stage: </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cprofile</span><span class="p">:</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">stage</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">pdb</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;There was an exception - starting python debugger because you ran with --pdb&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="n">pdb</span><span class="o">.</span><span class="n">post_mortem</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stage</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">pdb</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;There was an exception in the finalization - starting python debugger because you ran with --pdb&quot;</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="n">pdb</span><span class="o">.</span><span class="n">post_mortem</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cprofile</span><span class="p">:</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">dump_stats</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">cprofile</span><span class="p">)</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="s2">&quot;cumtime&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stage complete: </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PipelineStage.finalize"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finalize the stage, moving all its outputs to their final locations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Synchronize files so that everything is closed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mpi</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Barrier</span><span class="p">()</span>

        <span class="c1"># Move files to their final path</span>
        <span class="c1"># only the master process moves things</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_tags</span><span class="p">():</span>
                <span class="c1"># find the old and new names</span>
                <span class="n">temp_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">final_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">final_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># it&#39;s not an error here if the path does not exist,</span>
                <span class="c1"># because that will be handled later.</span>
                <span class="k">if</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">temp_name</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="c1"># replace directories, rather than nesting more results</span>
                    <span class="k">if</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">final_name</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">final_name</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">temp_name</span><span class="p">,</span> <span class="n">final_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;NOTE/WARNING: Expected output file </span><span class="si">{</span><span class="n">final_name</span><span class="si">}</span><span class="s2"> was not generated.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span></div>

    <span class="c1">#############################################</span>
    <span class="c1"># Parallelism-related methods and properties.</span>
    <span class="c1">#############################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The rank of this process under MPI (0 if not running under MPI)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rank</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The number or processes under MPI (1 if not running under MPI)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">comm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The MPI communicator object (None if not running under MPI)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_comm</span>

<div class="viewcode-block" id="PipelineStage.is_parallel"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.is_parallel">[docs]</a>    <span class="k">def</span> <span class="nf">is_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if the code is being run in parallel.</span>
<span class="sd">        Right now is_parallel() will return the same value as is_mpi(),</span>
<span class="sd">        but that may change in future if we implement other forms of</span>
<span class="sd">        parallelization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parallel</span> <span class="o">!=</span> <span class="n">SERIAL</span></div>

<div class="viewcode-block" id="PipelineStage.is_mpi"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.is_mpi">[docs]</a>    <span class="k">def</span> <span class="nf">is_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if the stage is being run under MPI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parallel</span> <span class="o">==</span> <span class="n">MPI_PARALLEL</span></div>

<div class="viewcode-block" id="PipelineStage.split_tasks_by_rank"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.split_tasks_by_rank">[docs]</a>    <span class="k">def</span> <span class="nf">split_tasks_by_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate through a list of items, yielding ones this process is responsible for/</span>

<span class="sd">        Tasks are allocated in a round-robin way.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tasks: iterable</span>
<span class="sd">            Tasks to split up</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">task</span></div>

<div class="viewcode-block" id="PipelineStage.data_ranges_by_rank"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.data_ranges_by_rank">[docs]</a>    <span class="k">def</span> <span class="nf">data_ranges_by_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_rows</span><span class="p">,</span> <span class="n">chunk_rows</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split a number of rows by process.</span>

<span class="sd">        Given a total number of rows to read and a chunk size, yield</span>
<span class="sd">        the ranges within them that this process should handle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_rows: int</span>
<span class="sd">            Total number of rows to split up</span>

<span class="sd">        chunk_rows: int</span>
<span class="sd">            Size of each chunk to be read.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_chunks</span> <span class="o">=</span> <span class="n">n_rows</span> <span class="o">//</span> <span class="n">chunk_rows</span>
        <span class="k">if</span> <span class="n">n_chunks</span> <span class="o">*</span> <span class="n">chunk_rows</span> <span class="o">&lt;</span> <span class="n">n_rows</span><span class="p">:</span>
            <span class="n">n_chunks</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_tasks_by_rank</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_chunks</span><span class="p">)):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">chunk_rows</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunk_rows</span><span class="p">,</span> <span class="n">n_rows</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span></div>

    <span class="c1">##################################################</span>
    <span class="c1"># Input and output-related methods and properties.</span>
    <span class="c1">##################################################</span>

<div class="viewcode-block" id="PipelineStage.get_input"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.get_input">[docs]</a>    <span class="k">def</span> <span class="nf">get_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the path of an input file with the given tag&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputs</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span></div>

<div class="viewcode-block" id="PipelineStage.get_output"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.get_output">[docs]</a>    <span class="k">def</span> <span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">final_name</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the path of an output file with the given tag</span>

<span class="sd">        If final_name is False then use a temporary name - file will</span>
<span class="sd">        be moved to its final name at the end</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputs</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>

        <span class="c1"># If not the final version, add a tag at the start of the filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">final_name</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="n">IN_PROGRESS_PREFIX</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="PipelineStage.open_input"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.open_input">[docs]</a>    <span class="k">def</span> <span class="nf">open_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find and open an input file with the given tag, in read-only mode.</span>

<span class="sd">        For general files this will simply return a standard</span>
<span class="sd">        python file object.</span>

<span class="sd">        For specialized file types like FITS or HDF5 it will return</span>
<span class="sd">        a more specific object - see the types.py file for more info.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">input_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input_type</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">input_class</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wrapper</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">file</span></div>

    <span class="k">def</span> <span class="nf">open_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">final_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find and open an output file with the given tag, in write mode.</span>

<span class="sd">        If final_name is True then they will be opened using their final</span>
<span class="sd">        target output name.  Otherwise we will prepend &quot;inprogress_&quot; to their</span>
<span class="sd">        file name. This means we know that if the final file exists then it</span>
<span class="sd">        is completed.</span>

<span class="sd">        If wrapper is True this will return an instance of the class</span>
<span class="sd">        of the file as specified in the cls.outputs.  Otherwise it will</span>
<span class="sd">        return an open file object (standard python one or something more</span>
<span class="sd">        specialized).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        tag: str</span>
<span class="sd">            Tag as listed in self.outputs</span>

<span class="sd">        wrapper: bool</span>
<span class="sd">            Default=False.  Whether to return a wrapped file</span>

<span class="sd">        final_name: bool</span>
<span class="sd">            Default=False. Whether to save to </span>

<span class="sd">        **kwargs:</span>
<span class="sd">            Extra args are passed on to the file&#39;s class constructor.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">final_name</span><span class="o">=</span><span class="n">final_name</span><span class="p">)</span>
        <span class="n">output_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_type</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

        <span class="c1"># HDF files can be opened for parallel writing</span>
        <span class="c1"># under MPI.  This checks if:</span>
        <span class="c1"># - we have been told to open in parallel</span>
        <span class="c1"># - we are actually running under MPI</span>
        <span class="c1"># and adds the flags required if all these are true</span>
        <span class="n">run_parallel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mpi</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">run_parallel</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mpio&quot;</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;comm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span>

            <span class="c1"># XXX: This is also not a dependency, but it should be.</span>
            <span class="c1">#      Or even better would be to make it a dependency of descformats where it</span>
            <span class="c1">#      is actually used.</span>
            <span class="kn">import</span> <span class="nn">h5py</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">h5py</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">mpi</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="n">dedent</span><span class="p">(</span>
                        <span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">                Your h5py installation is not MPI-enabled.</span>
<span class="sd">                Options include:</span>
<span class="sd">                  1) Set nprocess to 1 for all stages</span>
<span class="sd">                  2) Upgrade h5py to use mpi.  See instructions here:</span>
<span class="sd">                     http://docs.h5py.org/en/latest/build.html#custom-installation</span>
<span class="sd">                Note: If using conda, the most straightforward way is to enable it is</span>
<span class="sd">                    conda install -c spectraldns h5py-parallel</span>
<span class="sd">                &quot;&quot;&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;h5py module is not MPI-enabled.&quot;</span><span class="p">)</span>

        <span class="c1"># Return an opened object representing the file</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">output_class</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wrapper</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">file</span>

<div class="viewcode-block" id="PipelineStage.output_tags"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.output_tags">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">output_tags</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the list of output tags required by this stage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">outputs</span><span class="p">]</span></div>

<div class="viewcode-block" id="PipelineStage.input_tags"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.input_tags">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">input_tags</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the list of input tags required by this stage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span></div>

<div class="viewcode-block" id="PipelineStage.get_input_type"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.get_input_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_input_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the file type class of an input file with the given tag.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dt</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tag </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> is not a known input&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PipelineStage.get_output_type"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.get_output_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the file type class of an output file with the given tag.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dt</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tag </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2"> is not a known output&quot;</span><span class="p">)</span></div>

    <span class="c1">##################################################</span>
    <span class="c1"># Configuration-related methods and properties.</span>
    <span class="c1">##################################################</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the configuration dictionary for this stage, aggregating command</span>
<span class="sd">        line options and optional configuration file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configs</span>

<div class="viewcode-block" id="PipelineStage.read_config"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.read_config">[docs]</a>    <span class="k">def</span> <span class="nf">read_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function looks for the arguments of the pipeline stage using a</span>
<span class="sd">        combination of default values, command line options and separate</span>
<span class="sd">        configuration file.</span>

<span class="sd">        The order for resolving config options is first looking for a default</span>
<span class="sd">        value, then looking for a</span>

<span class="sd">        In case a mandatory argument (argument with no default) is missing,</span>
<span class="sd">        an exception is raised.</span>

<span class="sd">        Note that we recognize arguments with no default as the ones where</span>
<span class="sd">        self.config_options holds a type instead of a value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Try to load configuration file if provided</span>
        <span class="kn">import</span> <span class="nn">yaml</span>

        <span class="c1"># This is all the config information in the file, including</span>
        <span class="c1"># things for other stages</span>
        <span class="n">overall_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">)))</span>

        <span class="c1"># The user can define global options that are inherited by</span>
        <span class="c1"># all the other sections if not already specified there.</span>
        <span class="n">input_config</span> <span class="o">=</span> <span class="n">overall_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># This is just the config info in the file for this stage.</span>
        <span class="c1"># It may be incomplete - there may be things specified on the</span>
        <span class="c1"># command line instead, or just using their default values</span>
        <span class="n">stage_config</span> <span class="o">=</span> <span class="n">overall_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">input_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stage_config</span><span class="p">)</span>

        <span class="c1"># Here we build up the actual configuration we use on this</span>
        <span class="c1"># run from all these sources</span>
        <span class="n">my_config</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Loop over the options of the pipeline stage</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_options</span><span class="p">:</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">opt_type</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># First look for a default value,</span>
            <span class="c1"># if a type (like int) is provided as the default it indicates that</span>
            <span class="c1"># this option doesn&#39;t have a default (i.e. is mandatory) and should</span>
            <span class="c1"># be explicitly provided with the specified type</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_options</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span>
                <span class="n">opt_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_options</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>

            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_options</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_options</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span>
                    <span class="n">opt_type</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_options</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                    <span class="n">opt_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_options</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="n">opt_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

            <span class="c1"># Second, look for the option in the configuration file and override</span>
            <span class="c1"># default if provided TODO: Check types</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">input_config</span><span class="p">:</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="n">input_config</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>

            <span class="c1"># Finally check for command line option that would override the value</span>
            <span class="c1"># in the configuration file. Note that the argument parser should</span>
            <span class="c1"># already have taken care of type</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">opt</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>

            <span class="c1"># Finally, check that we got at least some value for this option</span>
            <span class="k">if</span> <span class="n">opt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing configuration option </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> for stage </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">my_config</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span>

        <span class="c1"># Unspecified parameters can also be copied over.</span>
        <span class="c1"># This will be needed for parameters that are more complicated, such</span>
        <span class="c1"># as dictionaries or other more structured parameter information.</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">input_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Omit things we&#39;ve already dealt with above</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_options</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># copy over everything else</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">my_config</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">return</span> <span class="n">my_config</span></div>

<div class="viewcode-block" id="PipelineStage.iterate_fits"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.iterate_fits">[docs]</a>    <span class="k">def</span> <span class="nf">iterate_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">hdunum</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">chunk_rows</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loop through chunks of the input data from a FITS file with the given tag</span>

<span class="sd">        TODO: add ceci tests of these functions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="n">hdunum</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">get_nrows</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ranges_by_rank</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">chunk_rows</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">read_columns</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
            <span class="k">yield</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">data</span></div>

<div class="viewcode-block" id="PipelineStage.iterate_hdf"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.iterate_hdf">[docs]</a>    <span class="k">def</span> <span class="nf">iterate_hdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">chunk_rows</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loop through chunks of the input data from an HDF5 file with the given tag.</span>

<span class="sd">        All the selected columns must have the same length.</span>

<span class="sd">        TODO: add ceci tests of these functions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="n">hdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">hdf</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span>

        <span class="c1"># Check all the columns are the same length</span>
        <span class="n">N</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Different columns among </span><span class="si">{</span><span class="n">cols</span><span class="si">}</span><span class="s2"> in file </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="se">\</span>
<span class="s2">            group </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2"> are different sizes - cannot use iterate_hdf&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Iterate through the data providing chunks</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_ranges_by_rank</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">chunk_rows</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">}</span>
            <span class="k">yield</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">data</span></div>

    <span class="c1">################################</span>
    <span class="c1"># Pipeline-related methods</span>
    <span class="c1">################################</span>

<div class="viewcode-block" id="PipelineStage.generate_command"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.generate_command">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">generate_command</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a command line that will run the stage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_module</span><span class="p">()</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fpath</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing input location </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">fpath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--config=</span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fpath</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing output location </span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">fpath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="s2">&quot;   &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>

        <span class="c1"># We just return this, instead of wrapping it in a</span>
        <span class="c1"># parsl job</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;python3 -m </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">flags</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">cmd</span></div>

<div class="viewcode-block" id="PipelineStage.generate_cwl"><a class="viewcode-back" href="../../base_stage.html#txpipe.base_stage.PipelineStage.generate_cwl">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">generate_cwl</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">log_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produces a CWL App object which can then be exported to yaml</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">cwlgen</span>

        <span class="n">module</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_module</span><span class="p">()</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Basic definition of the tool</span>
        <span class="n">cwl_tool</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandLineTool</span><span class="p">(</span>
            <span class="n">tool_id</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">base_command</span><span class="o">=</span><span class="s2">&quot;python3&quot;</span><span class="p">,</span>
            <span class="n">cwl_version</span><span class="o">=</span><span class="s2">&quot;v1.0&quot;</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">log_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cwl_tool</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.out&quot;</span>
            <span class="n">cwl_tool</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.err&quot;</span>

        <span class="c1"># Adds the first input binding with the name of the module and pipeline stage</span>
        <span class="n">input_arg</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandLineBinding</span><span class="p">(</span><span class="n">position</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">value_from</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;-m</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cwl_tool</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_arg</span><span class="p">)</span>
        <span class="n">input_arg</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandLineBinding</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">value_from</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cwl_tool</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_arg</span><span class="p">)</span>

        <span class="n">type_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">:</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">}</span>
        <span class="c1"># Adds the parameters of the tool</span>
        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">config_options</span><span class="p">:</span>
            <span class="n">def_val</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">config_options</span><span class="p">[</span><span class="n">opt</span><span class="p">]</span>

            <span class="c1"># Handles special case of lists:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">def_val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">def_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">param_type</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">type_dict</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span> <span class="k">else</span> <span class="n">type_dict</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)],</span>
                <span class="p">}</span>
                <span class="n">default</span> <span class="o">=</span> <span class="n">def_val</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">input_binding</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandLineBinding</span><span class="p">(</span>
                    <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;--</span><span class="si">{}</span><span class="s2">=&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">),</span> <span class="n">item_separator</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">separate</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_type</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">type_dict</span><span class="p">[</span><span class="n">def_val</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">def_val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span>
                    <span class="k">else</span> <span class="n">type_dict</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">def_val</span><span class="p">)]</span>
                <span class="p">)</span>
                <span class="n">default</span> <span class="o">=</span> <span class="n">def_val</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">def_val</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">param_type</span> <span class="o">==</span> <span class="s2">&quot;boolean&quot;</span><span class="p">:</span>
                    <span class="n">input_binding</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandLineBinding</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;--</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">input_binding</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandLineBinding</span><span class="p">(</span>
                        <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;--</span><span class="si">{}</span><span class="s2">=&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">),</span> <span class="n">separate</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>

            <span class="n">input_param</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandInputParameter</span><span class="p">(</span>
                <span class="n">opt</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span>
                <span class="n">param_type</span><span class="o">=</span><span class="n">param_type</span><span class="p">,</span>
                <span class="n">input_binding</span><span class="o">=</span><span class="n">input_binding</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Some documentation about this parameter&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># We are bypassing the cwlgen builtin type check for the special case</span>
            <span class="c1"># of arrays until that gets added to the standard</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">def_val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">input_param</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">param_type</span>

            <span class="n">cwl_tool</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_param</span><span class="p">)</span>

        <span class="c1"># Add the inputs of the tool</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">inp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">input_tags</span><span class="p">()):</span>
            <span class="n">input_binding</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandLineBinding</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;--</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inp</span><span class="p">))</span>
            <span class="n">input_param</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandInputParameter</span><span class="p">(</span>
                <span class="n">inp</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">inp</span><span class="p">,</span>
                <span class="n">param_type</span><span class="o">=</span><span class="s2">&quot;File&quot;</span><span class="p">,</span>
                <span class="n">param_format</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
                <span class="n">input_binding</span><span class="o">=</span><span class="n">input_binding</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Some documentation about the input&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cwl_tool</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_param</span><span class="p">)</span>

        <span class="c1"># Adds the overall configuration file</span>
        <span class="n">input_binding</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandLineBinding</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;--config&quot;</span><span class="p">)</span>
        <span class="n">input_param</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandInputParameter</span><span class="p">(</span>
            <span class="s2">&quot;config&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;config&quot;</span><span class="p">,</span>
            <span class="n">param_type</span><span class="o">=</span><span class="s2">&quot;File&quot;</span><span class="p">,</span>
            <span class="n">param_format</span><span class="o">=</span><span class="s2">&quot;http://edamontology.org/format_3750&quot;</span><span class="p">,</span>
            <span class="n">input_binding</span><span class="o">=</span><span class="n">input_binding</span><span class="p">,</span>
            <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Configuration file&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">cwl_tool</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_param</span><span class="p">)</span>

        <span class="c1"># Add the definition of the outputs</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">output_tags</span><span class="p">()):</span>
            <span class="n">output_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">make_name</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="n">output_binding</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandOutputBinding</span><span class="p">(</span><span class="n">glob</span><span class="o">=</span><span class="n">output_name</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandOutputParameter</span><span class="p">(</span>
                <span class="n">out</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
                <span class="n">param_type</span><span class="o">=</span><span class="s2">&quot;File&quot;</span><span class="p">,</span>
                <span class="n">output_binding</span><span class="o">=</span><span class="n">output_binding</span><span class="p">,</span>
                <span class="n">param_format</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Some results produced by the pipeline element&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cwl_tool</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandOutputParameter</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">@stdout&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;stdout&quot;</span><span class="p">,</span>
                <span class="n">param_type</span><span class="o">=</span><span class="s2">&quot;stdout&quot;</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Pipeline elements standard output&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cwl_tool</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">cwlgen</span><span class="o">.</span><span class="n">CommandOutputParameter</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">@stderr&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;stderr&quot;</span><span class="p">,</span>
                <span class="n">param_type</span><span class="o">=</span><span class="s2">&quot;stderr&quot;</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Pipeline elements standard output&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cwl_tool</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="c1"># Potentially add more metadata</span>
        <span class="c1"># This requires a schema however...</span>
        <span class="c1"># metadata = {&#39;name&#39;: cls.name,</span>
        <span class="c1">#         &#39;about&#39;: &#39;Some additional info&#39;,</span>
        <span class="c1">#         &#39;publication&#39;: [{&#39;id&#39;: &#39;one_doi&#39;}, {&#39;id&#39;: &#39;another_doi&#39;}],</span>
        <span class="c1">#         &#39;license&#39;: [&#39;MIT&#39;]}</span>
        <span class="c1"># cwl_tool.metadata = cwlgen.Metadata(**metadata)</span>

        <span class="k">return</span> <span class="n">cwl_tool</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, DESC

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>