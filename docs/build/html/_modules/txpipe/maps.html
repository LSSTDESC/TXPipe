<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>txpipe.maps &mdash; TXPipe  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> TXPipe
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">TXPipe Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example.html">Running an example pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running.html">Running a pipeline:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hdf5.html">Reading HDF5 Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stages/stages.html">Stages implemented in TX-Pipe:</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">TXPipe</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>txpipe.maps</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for txpipe.maps</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">.base_stage</span> <span class="kn">import</span> <span class="n">PipelineStage</span>
<span class="kn">from</span> <span class="nn">.data_types</span> <span class="kn">import</span> <span class="n">TomographyCatalog</span><span class="p">,</span> <span class="n">MapsFile</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">,</span> <span class="n">ShearCatalog</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">unique_list</span><span class="p">,</span> <span class="n">choose_pixelization</span>
<span class="kn">from</span> <span class="nn">.utils.calibration_tools</span> <span class="kn">import</span> <span class="n">read_shear_catalog_type</span><span class="p">,</span> <span class="n">apply_metacal_response</span>
<span class="kn">from</span> <span class="nn">.utils.calibrators</span> <span class="kn">import</span> <span class="n">LensfitCalibrator</span>
<span class="kn">from</span> <span class="nn">.mapping</span> <span class="kn">import</span> <span class="n">Mapper</span><span class="p">,</span> <span class="n">FlagMapper</span>


<span class="n">SHEAR_SHEAR</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">SHEAR_POS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">POS_POS</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># These generic mapping options are used by multiple different</span>
<span class="c1"># map types.</span>
<span class="c1"># TODO: consider dropping support for gnomonic maps.</span>
<span class="c1"># Also consider adding support for pixell</span>
<span class="n">map_config_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;chunk_rows&quot;</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>  <span class="c1"># The number of rows to read in each chunk of data at a time</span>
    <span class="s2">&quot;pixelization&quot;</span><span class="p">:</span> <span class="s2">&quot;healpix&quot;</span><span class="p">,</span>  <span class="c1"># The pixelization scheme to use, currently just healpix</span>
    <span class="s2">&quot;nside&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># The Healpix resolution parameter for the generated maps. Only req&#39;d if using healpix</span>
    <span class="s2">&quot;sparse&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Whether to generate sparse maps - faster and less memory for small sky areas,</span>
    <span class="s2">&quot;ra_cent&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>  <span class="c1"># These parameters are only required if pixelization==tan</span>
    <span class="s2">&quot;dec_cent&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
    <span class="s2">&quot;npix_x&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;npix_y&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;pixel_size&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>  <span class="c1"># Pixel size of pixelization scheme</span>
<span class="p">}</span>


<div class="viewcode-block" id="TXBaseMaps"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXBaseMaps">[docs]</a><span class="k">class</span> <span class="nc">TXBaseMaps</span><span class="p">(</span><span class="n">PipelineStage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is an abstract base mapping class, which other subclasses</span>
<span class="sd">    inherit from to use the same basic structure, which is:</span>
<span class="sd">    - select pixelization</span>
<span class="sd">    - prepare some mapper objects</span>
<span class="sd">    - iterate through selected columns</span>
<span class="sd">        - update each mapper with each chunk</span>
<span class="sd">    - finalize the mappers</span>
<span class="sd">    - save the maps</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TXBaseMaps&quot;</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">config_options</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Read input configuration information</span>
        <span class="c1"># and select pixel scheme. Also save the scheme</span>
        <span class="c1"># metadata so we can save it later</span>
        <span class="n">pixel_scheme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_pixel_scheme</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pixel_scheme</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c1"># Initialize our maps</span>
        <span class="n">mappers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_mappers</span><span class="p">(</span><span class="n">pixel_scheme</span><span class="p">)</span>

        <span class="c1"># Loop through the data</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_iterator</span><span class="p">():</span>
            <span class="c1"># Give an idea of progress</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="si">}</span><span class="s2"> read data chunk </span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">e</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Build up any maps we are using</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accumulate_maps</span><span class="p">(</span><span class="n">pixel_scheme</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mappers</span><span class="p">)</span>

        <span class="c1"># Finalize and output the maps</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalize_mappers</span><span class="p">(</span><span class="n">pixel_scheme</span><span class="p">,</span> <span class="n">mappers</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_maps</span><span class="p">(</span><span class="n">pixel_scheme</span><span class="p">,</span> <span class="n">maps</span><span class="p">)</span>

<div class="viewcode-block" id="TXBaseMaps.choose_pixel_scheme"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXBaseMaps.choose_pixel_scheme">[docs]</a>    <span class="k">def</span> <span class="nf">choose_pixel_scheme</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subclasses can override to instead load pixelization</span>
<span class="sd">        from an existing map</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">choose_pixelization</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div>

<div class="viewcode-block" id="TXBaseMaps.prepare_mappers"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXBaseMaps.prepare_mappers">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_scheme</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subclasses must override to init any mapper objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Do not use TXBaseMaps - use a subclass&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TXBaseMaps.data_iterator"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXBaseMaps.data_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">data_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subclasses must override to create an iterator looping over</span>
<span class="sd">        input data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Do not use TXBaseMaps - use a subclass&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TXBaseMaps.accumulate_maps"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXBaseMaps.accumulate_maps">[docs]</a>    <span class="k">def</span> <span class="nf">accumulate_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_scheme</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mappers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subclasses must override to supply the next chunk &quot;data&quot; to</span>
<span class="sd">        their mappers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Do not use TXBaseMaps - use a subclass&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TXBaseMaps.finalize_mappers"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXBaseMaps.finalize_mappers">[docs]</a>    <span class="k">def</span> <span class="nf">finalize_mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_scheme</span><span class="p">,</span> <span class="n">mappers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subclasses must override to finalize their maps and return</span>
<span class="sd">        a dictionary of (output_tag, map_name) -&gt; (pixels, values)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Do not use TXBaseMaps - use a subclass&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TXBaseMaps.save_maps"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXBaseMaps.save_maps">[docs]</a>    <span class="k">def</span> <span class="nf">save_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_scheme</span><span class="p">,</span> <span class="n">maps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subclasses can use this directly, by generating maps as described</span>
<span class="sd">        in finalize_mappers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find and open all output files</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">unique_list</span><span class="p">([</span><span class="n">outfile</span> <span class="k">for</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">maps</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        <span class="n">output_files</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tag</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;maps&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># add a maps section to each</span>
        <span class="k">for</span> <span class="n">output_file</span> <span class="ow">in</span> <span class="n">output_files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;maps&quot;</span><span class="p">)</span>
            <span class="n">output_file</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="s2">&quot;maps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># same the relevant maps in each</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">map_name</span><span class="p">),</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">map_data</span><span class="p">)</span> <span class="ow">in</span> <span class="n">maps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">output_files</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">write_map</span><span class="p">(</span><span class="n">map_name</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">map_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TXSourceMaps"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXSourceMaps">[docs]</a><span class="k">class</span> <span class="nc">TXSourceMaps</span><span class="p">(</span><span class="n">TXBaseMaps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make g1, g2, var(g1), var(g2), and lensing weight maps</span>
<span class="sd">    from shear catalogs and tomography</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TXSourceMaps&quot;</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;shear_catalog&quot;</span><span class="p">,</span> <span class="n">ShearCatalog</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;shear_tomography_catalog&quot;</span><span class="p">,</span> <span class="n">TomographyCatalog</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;source_maps&quot;</span><span class="p">,</span> <span class="n">MapsFile</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="c1"># Generic mapping options + one option</span>
    <span class="c1"># to use the truth shear columns</span>
    <span class="n">config_options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;true_shear&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">map_config_options</span><span class="p">}</span>

<div class="viewcode-block" id="TXSourceMaps.prepare_mappers"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXSourceMaps.prepare_mappers">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_scheme</span><span class="p">):</span>
        <span class="c1"># read shear cols and calibration info</span>
        <span class="n">nbin_source</span><span class="p">,</span> <span class="n">cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_calibrators</span><span class="p">()</span>

        <span class="c1"># store in config so it is saved later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nbin_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbin_source</span>
        <span class="c1"># create basic mapper object</span>
        <span class="n">source_bins</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nbin_source</span><span class="p">))</span>
        <span class="n">lens_bins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">Mapper</span><span class="p">(</span>
            <span class="n">pixel_scheme</span><span class="p">,</span>
            <span class="n">lens_bins</span><span class="p">,</span>
            <span class="n">source_bins</span><span class="p">,</span>
            <span class="n">do_lens</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">sparse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;sparse&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">mapper</span><span class="p">,</span> <span class="n">cal</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">get_calibrators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shear_catalog_type</span> <span class="o">=</span> <span class="n">read_shear_catalog_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s2">&quot;shear_tomography_catalog&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nbin_source</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;tomography&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;nbin_source&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">shear_catalog_type</span> <span class="o">==</span> <span class="s2">&quot;metacal&quot;</span><span class="p">:</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;/metacal_response/R_total&#39;</span><span class="p">][:]</span> <span class="c1"># nbin x 2 x 2</span>
                <span class="n">cal</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin_source</span><span class="p">)}</span>
                <span class="n">cal</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;/metacal_response/R_total_2d&#39;</span><span class="p">][:]</span>
            <span class="k">elif</span> <span class="n">shear_catalog_type</span> <span class="o">==</span> <span class="s2">&quot;lensfit&quot;</span><span class="p">:</span>
                <span class="n">K</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;/response/K&#39;</span><span class="p">][:]</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;/response/C&#39;</span><span class="p">][:]</span>
                <span class="n">cal</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">(</span><span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin_source</span><span class="p">)}</span>
                <span class="n">cal</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;/response/K_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;/response/C_2d&#39;</span><span class="p">][:],</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">shear_catalog_type</span> <span class="o">==</span> <span class="s2">&quot;hsc&quot;</span><span class="p">:</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;/response/R&#39;</span><span class="p">][:]</span>
                <span class="n">K</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;/response/K&#39;</span><span class="p">][:]</span>
                <span class="n">cal</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin_source</span><span class="p">)}</span>
                <span class="n">cal</span><span class="p">[</span><span class="s1">&#39;2D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;/response/R_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;/response/K_2d&#39;</span><span class="p">][:],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown calibration&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nbin_source</span><span class="p">,</span> <span class="n">cal</span>

<div class="viewcode-block" id="TXSourceMaps.data_iterator"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXSourceMaps.data_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">data_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># can optionally read truth values</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;true_shear&quot;</span><span class="p">]:</span>
            <span class="n">shear_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;true_g1&quot;</span><span class="p">,</span> <span class="s2">&quot;true_g2&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;shear_catalog_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;metacal&quot;</span><span class="p">:</span>
            <span class="n">shear_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mcal_g1&quot;</span><span class="p">,</span> <span class="s2">&quot;mcal_g2&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shear_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;g1&quot;</span><span class="p">,</span> <span class="s2">&quot;g2&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]</span>

        <span class="c1"># use utility function that combines data chunks</span>
        <span class="c1"># from different files. Reading from n file sections</span>
        <span class="c1"># takes 3n+1 arguments</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_iterators</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;chunk_rows&quot;</span><span class="p">],</span>  <span class="c1"># number of rows to iterate at once</span>
            <span class="c1"># first file info</span>
            <span class="s2">&quot;shear_catalog&quot;</span><span class="p">,</span>  <span class="c1"># tag of input file to iterate through</span>
            <span class="s2">&quot;shear&quot;</span><span class="p">,</span>  <span class="c1"># data group within file to look at</span>
            <span class="n">shear_cols</span><span class="p">,</span>  <span class="c1"># column(s) to read</span>
            <span class="c1"># next file</span>
            <span class="s2">&quot;shear_tomography_catalog&quot;</span><span class="p">,</span>  <span class="c1"># tag of input file to iterate through</span>
            <span class="s2">&quot;tomography&quot;</span><span class="p">,</span>  <span class="c1"># data group within file to look at</span>
            <span class="p">[</span><span class="s2">&quot;source_bin&quot;</span><span class="p">],</span>  <span class="c1"># column(s) to read</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TXSourceMaps.accumulate_maps"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXSourceMaps.accumulate_maps">[docs]</a>    <span class="k">def</span> <span class="nf">accumulate_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_scheme</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mappers</span><span class="p">):</span>
        <span class="c1"># rename columns, if needed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;true_shear&quot;</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;g1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;true_g1&quot;</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;g2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;true_g2&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;shear_catalog_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;metacal&quot;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;g1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;mcal_g1&quot;</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;g2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;mcal_g2&quot;</span><span class="p">]</span>
        <span class="c1"># for other catalogs they&#39;re just called g1, g2 aready</span>

        <span class="c1"># send data to map</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">mappers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">calibrate_map_metacal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">,</span> <span class="n">var_g2</span><span class="p">,</span> <span class="n">R</span><span class="p">):</span>
        <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">apply_metacal_response</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">)</span>

        <span class="n">std_g1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_g1</span><span class="p">)</span>
        <span class="n">std_g2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_g2</span><span class="p">)</span>
        <span class="n">std_g1</span><span class="p">,</span> <span class="n">std_g2</span> <span class="o">=</span> <span class="n">apply_metacal_response</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">std_g1</span><span class="p">,</span> <span class="n">std_g2</span><span class="p">)</span>

        <span class="n">var_g1</span> <span class="o">=</span> <span class="n">std_g1</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">var_g2</span> <span class="o">=</span> <span class="n">std_g2</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">,</span> <span class="n">var_g2</span>


    <span class="k">def</span> <span class="nf">calibrate_map_lensfit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">,</span> <span class="n">var_g2</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">calib</span> <span class="o">=</span> <span class="n">LensfitCalibrator</span><span class="p">(</span><span class="n">K</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>

        <span class="n">g1</span><span class="p">,</span><span class="n">g2</span> <span class="o">=</span> <span class="n">calib</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span><span class="n">g2</span><span class="p">,</span><span class="n">subtract_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">var_g1</span><span class="p">,</span><span class="n">var_g2</span> <span class="o">=</span> <span class="n">calib</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span><span class="n">g2</span><span class="p">,</span><span class="n">subtract_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">,</span> <span class="n">var_g2</span>

    <span class="k">def</span> <span class="nf">calibrate_map_hsc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">,</span> <span class="n">var_g2</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;need to write calibrate map hsc function&quot;</span>

    <span class="k">def</span> <span class="nf">calibrate_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">,</span> <span class="n">var_g2</span><span class="p">,</span> <span class="n">cal</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">healpy</span>

        <span class="c1"># We will return lists of calibrated maps</span>
        <span class="n">g1_out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">g2_out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">var_g1_out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">var_g2_out</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># We calibrate the 2D case separately</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">g1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># we want to avoid accidentally calibrating any pixels</span>
            <span class="c1"># that should be masked.</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
                  <span class="p">(</span><span class="n">g1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">healpy</span><span class="o">.</span><span class="n">UNSEEN</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">g2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">healpy</span><span class="o">.</span><span class="n">UNSEEN</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">var_g1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">healpy</span><span class="o">.</span><span class="n">UNSEEN</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">var_g2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">healpy</span><span class="o">.</span><span class="n">UNSEEN</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;shear_catalog_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;metacal&#39;</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_map_metacal</span><span class="p">(</span><span class="n">g1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">g2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">var_g1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">var_g2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cal</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;shear_catalog_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;lensfit&#39;</span><span class="p">:</span>
                <span class="n">K</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_map_lensfit</span><span class="p">(</span><span class="n">g1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">g2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">var_g1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">var_g2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;shear_catalog_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hsc&#39;</span><span class="p">:</span>
                <span class="n">R</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_map_hsc</span><span class="p">(</span><span class="n">g1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">g2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">var_g1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">var_g2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">R</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown calibration&quot;</span><span class="p">)</span>

            <span class="c1"># re-apply the masking, just to make sure</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">healpy</span><span class="o">.</span><span class="n">UNSEEN</span>

            <span class="c1"># append our results for this tomographic bin</span>
            <span class="n">g1_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">g2_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">var_g1_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">var_g2_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">g1_out</span><span class="p">,</span> <span class="n">g2_out</span><span class="p">,</span> <span class="n">var_g1_out</span><span class="p">,</span> <span class="n">var_g2_out</span>


<div class="viewcode-block" id="TXSourceMaps.finalize_mappers"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXSourceMaps.finalize_mappers">[docs]</a>    <span class="k">def</span> <span class="nf">finalize_mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_scheme</span><span class="p">,</span> <span class="n">mappers</span><span class="p">):</span>
        <span class="c1"># only one mapper here - we call its finalize method</span>
        <span class="c1"># to collect everything</span>
        <span class="n">mapper</span><span class="p">,</span> <span class="n">cal</span> <span class="o">=</span> <span class="n">mappers</span>
        <span class="n">pix</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">,</span> <span class="n">var_g2</span><span class="p">,</span> <span class="n">weights_g</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">)</span>

        <span class="c1"># build up output</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># only master gets full stuff</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">maps</span>

        <span class="c1"># Calibrate the maps</span>
        <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">,</span> <span class="n">var_g2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_maps</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">,</span> <span class="n">var_g2</span><span class="p">,</span> <span class="n">cal</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">source_bins</span><span class="p">:</span>
            <span class="c1"># keys are the output tag and the map name</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;source_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;g1_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">g1</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;source_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;g2_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">g2</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;source_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;var_g1_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;source_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;var_g2_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">var_g2</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;source_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;lensing_weight_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">weights_g</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">maps</span></div></div>


<div class="viewcode-block" id="TXLensMaps"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXLensMaps">[docs]</a><span class="k">class</span> <span class="nc">TXLensMaps</span><span class="p">(</span><span class="n">TXBaseMaps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make galaxy number count maps from photometry</span>
<span class="sd">    and lens tomography.</span>

<span class="sd">    Density maps are made later once masks are generated.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TXLensMaps&quot;</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;photometry_catalog&quot;</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;lens_tomography_catalog&quot;</span><span class="p">,</span> <span class="n">TomographyCatalog</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;lens_maps&quot;</span><span class="p">,</span> <span class="n">MapsFile</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">config_options</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">map_config_options</span><span class="p">}</span>

<div class="viewcode-block" id="TXLensMaps.prepare_mappers"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXLensMaps.prepare_mappers">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_scheme</span><span class="p">):</span>
        <span class="c1"># read nbin_lens and save</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s2">&quot;lens_tomography_catalog&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nbin_lens</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;tomography&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;nbin_lens&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nbin_lens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbin_lens</span>

        <span class="c1"># create lone mapper</span>
        <span class="n">lens_bins</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nbin_lens</span><span class="p">))</span>
        <span class="n">source_bins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">Mapper</span><span class="p">(</span>
            <span class="n">pixel_scheme</span><span class="p">,</span>
            <span class="n">lens_bins</span><span class="p">,</span>
            <span class="n">source_bins</span><span class="p">,</span>
            <span class="n">do_g</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">sparse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;sparse&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">mapper</span><span class="p">]</span></div>

<div class="viewcode-block" id="TXLensMaps.data_iterator"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXLensMaps.data_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">data_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TODO: add use of lens weights here&quot;</span><span class="p">)</span>
        <span class="c1"># see TXSourceMaps abov for info on this</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_iterators</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;chunk_rows&quot;</span><span class="p">],</span>
            <span class="c1"># first file</span>
            <span class="s2">&quot;photometry_catalog&quot;</span><span class="p">,</span>
            <span class="s2">&quot;photometry&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">],</span>
            <span class="c1"># next file</span>
            <span class="s2">&quot;lens_tomography_catalog&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tomography&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;lens_bin&quot;</span><span class="p">],</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TXLensMaps.accumulate_maps"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXLensMaps.accumulate_maps">[docs]</a>    <span class="k">def</span> <span class="nf">accumulate_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_scheme</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mappers</span><span class="p">):</span>
        <span class="c1"># no need to rename cols here since just ra, dec, lens_bin</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">mappers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mapper</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="TXLensMaps.finalize_mappers"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXLensMaps.finalize_mappers">[docs]</a>    <span class="k">def</span> <span class="nf">finalize_mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_scheme</span><span class="p">,</span> <span class="n">mappers</span><span class="p">):</span>
        <span class="c1"># Again just the one mapper</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">mappers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Ignored return values are empty dicts for shear</span>
        <span class="n">pix</span><span class="p">,</span> <span class="n">ngal</span><span class="p">,</span> <span class="n">weighted_ngal</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">)</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">maps</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">lens_bins</span><span class="p">:</span>
            <span class="c1"># keys are the output tag and the map name</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;lens_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ngal_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">ngal</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;lens_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;weighted_ngal_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">weighted_ngal</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">maps</span></div></div>


<div class="viewcode-block" id="TXExternalLensMaps"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXExternalLensMaps">[docs]</a><span class="k">class</span> <span class="nc">TXExternalLensMaps</span><span class="p">(</span><span class="n">TXLensMaps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Same as TXLensMaps except it reads from an external</span>
<span class="sd">    lens catalog.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TXExternalLensMaps&quot;</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;lens_catalog&quot;</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;lens_tomography_catalog&quot;</span><span class="p">,</span> <span class="n">TomographyCatalog</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">config_options</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">map_config_options</span><span class="p">}</span>

<div class="viewcode-block" id="TXExternalLensMaps.data_iterator"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXExternalLensMaps.data_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">data_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># See TXSourceMaps for an explanation of thsis</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_iterators</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;chunk_rows&quot;</span><span class="p">],</span>
            <span class="c1"># first file</span>
            <span class="s2">&quot;lens_catalog&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lens&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">],</span>
            <span class="c1"># next file</span>
            <span class="s2">&quot;lens_tomography_catalog&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tomography&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;lens_bin&quot;</span><span class="p">,</span> <span class="s2">&quot;lens_weight&quot;</span><span class="p">],</span>
            <span class="c1"># another section in the same file</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="TXMainMaps"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXMainMaps">[docs]</a><span class="k">class</span> <span class="nc">TXMainMaps</span><span class="p">(</span><span class="n">TXSourceMaps</span><span class="p">,</span> <span class="n">TXLensMaps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combined source and photometric lens maps, from the</span>
<span class="sd">    same photometry catalog. This might be slightly faster than</span>
<span class="sd">    running two maps separately, but it only works if the source </span>
<span class="sd">    and lens catalogs are the same set of objects. Otherwise use</span>
<span class="sd">    TXSourceMaps and TXLensMaps.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TXMainMaps&quot;</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;photometry_catalog&quot;</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;lens_tomography_catalog&quot;</span><span class="p">,</span> <span class="n">TomographyCatalog</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;shear_tomography_catalog&quot;</span><span class="p">,</span> <span class="n">TomographyCatalog</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;shear_catalog&quot;</span><span class="p">,</span> <span class="n">ShearCatalog</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;lens_maps&quot;</span><span class="p">,</span> <span class="n">MapsFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;source_maps&quot;</span><span class="p">,</span> <span class="n">MapsFile</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">config_options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;true_shear&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">map_config_options</span><span class="p">}</span>

<div class="viewcode-block" id="TXMainMaps.data_iterator"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXMainMaps.data_iterator">[docs]</a>    <span class="k">def</span> <span class="nf">data_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This is just the combination of</span>
        <span class="c1"># the source and lens map columns</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TODO: no lens weights here&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s2">&quot;photometry_catalog&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">sz1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;photometry/ra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s2">&quot;shear_catalog&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">sz2</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;shear/ra&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">sz1</span> <span class="o">!=</span> <span class="n">sz2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shear and photometry catalogs in TXMainMaps are &quot;</span>
                             <span class="s2">&quot;different sizes. To use separate source and lens &quot;</span>
                             <span class="s2">&quot;samples use TXSourceMaps and TXLensMaps separately.&quot;</span>
                             <span class="p">)</span>

        <span class="c1"># metacal, lensfit, etc.</span>
        <span class="n">shear_catalog_type</span> <span class="o">=</span> <span class="n">read_shear_catalog_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># can optionally read truth values, or otherwise will look for</span>
        <span class="c1"># lensfit or metacal col names</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;true_shear&quot;</span><span class="p">]:</span>
            <span class="n">shear_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;true_g1&quot;</span><span class="p">,</span> <span class="s2">&quot;true_g1&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">shear_catalog_type</span> <span class="o">==</span> <span class="s2">&quot;metacal&quot;</span><span class="p">:</span>
            <span class="n">shear_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mcal_g1&quot;</span><span class="p">,</span> <span class="s2">&quot;mcal_g2&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shear_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;g1&quot;</span><span class="p">,</span> <span class="s2">&quot;g2&quot;</span><span class="p">,</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combined_iterators</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;chunk_rows&quot;</span><span class="p">],</span>
            <span class="c1"># first file</span>
            <span class="s2">&quot;photometry_catalog&quot;</span><span class="p">,</span>
            <span class="s2">&quot;photometry&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">],</span>
            <span class="c1"># next file</span>
            <span class="s2">&quot;shear_catalog&quot;</span><span class="p">,</span>
            <span class="s2">&quot;shear&quot;</span><span class="p">,</span>
            <span class="n">shear_cols</span><span class="p">,</span>
            <span class="c1"># next file</span>
            <span class="s2">&quot;lens_tomography_catalog&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tomography&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;lens_bin&quot;</span><span class="p">,</span> <span class="s2">&quot;lens_weight&quot;</span><span class="p">],</span>
            <span class="c1"># next file</span>
            <span class="s2">&quot;shear_tomography_catalog&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tomography&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;source_bin&quot;</span><span class="p">],</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TXMainMaps.prepare_mappers"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXMainMaps.prepare_mappers">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_scheme</span><span class="p">):</span>
        <span class="n">nbin_source</span><span class="p">,</span> <span class="n">cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_calibrators</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s2">&quot;lens_tomography_catalog&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">nbin_lens</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;tomography&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;nbin_lens&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nbin_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbin_source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nbin_lens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nbin_lens</span>

        <span class="n">source_bins</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nbin_source</span><span class="p">))</span>
        <span class="n">lens_bins</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nbin_lens</span><span class="p">))</span>

        <span class="c1"># still a single mapper doing source and lens</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">Mapper</span><span class="p">(</span>
            <span class="n">pixel_scheme</span><span class="p">,</span> <span class="n">lens_bins</span><span class="p">,</span> <span class="n">source_bins</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;sparse&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">mapper</span><span class="p">,</span> <span class="n">cal</span><span class="p">]</span></div>

    <span class="c1"># accumulate_maps is inherited from TXSourceMaps because</span>
    <span class="c1"># that appears first in the parent classes</span>

<div class="viewcode-block" id="TXMainMaps.finalize_mappers"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXMainMaps.finalize_mappers">[docs]</a>    <span class="k">def</span> <span class="nf">finalize_mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel_scheme</span><span class="p">,</span> <span class="n">mappers</span><span class="p">):</span>
        <span class="c1"># Still one mapper, but now we read both source and</span>
        <span class="c1"># lens maps from it.</span>
        <span class="n">mapper</span><span class="p">,</span> <span class="n">cal</span> <span class="o">=</span> <span class="n">mappers</span>
        <span class="n">pix</span><span class="p">,</span> <span class="n">ngal</span><span class="p">,</span> <span class="n">weighted_ngal</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">,</span> <span class="n">var_g2</span><span class="p">,</span> <span class="n">weights_g</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">)</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">maps</span>

        <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">,</span> <span class="n">var_g2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibrate_maps</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">,</span> <span class="n">var_g2</span><span class="p">,</span> <span class="n">cal</span><span class="p">)</span>

        <span class="c1"># Now both loops, source and lens</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">lens_bins</span><span class="p">:</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;lens_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ngal_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">ngal</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;lens_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;weighted_ngal_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">weighted_ngal</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">source_bins</span><span class="p">:</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;source_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;g1_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">g1</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;source_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;g2_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">g2</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;source_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;var_g1_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">var_g1</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;source_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;var_g2_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">var_g2</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
            <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;source_maps&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;lensing_weight_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">weights_g</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">maps</span></div></div>


<div class="viewcode-block" id="TXDensityMaps"><a class="viewcode-back" href="../../stages/maps.html#txpipe.maps.TXDensityMaps">[docs]</a><span class="k">class</span> <span class="nc">TXDensityMaps</span><span class="p">(</span><span class="n">PipelineStage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert n_gal maps to overdensity delta maps</span>
<span class="sd">    delta = (ngal - &lt;ngal&gt;) / &lt;ngal&gt;</span>

<span class="sd">    This has to be separate from the lens mappers above</span>
<span class="sd">    because it requires the mask, which is created elsewhere</span>
<span class="sd">    (right now in masks.py)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;TXDensityMaps&quot;</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;lens_maps&quot;</span><span class="p">,</span> <span class="n">MapsFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="n">MapsFile</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;density_maps&quot;</span><span class="p">,</span> <span class="n">MapsFile</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">healpy</span>

        <span class="c1"># Read the mask</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read_map</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">)</span>

        <span class="c1"># set unseen pixels to weight zero</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="n">healpy</span><span class="o">.</span><span class="n">UNSEEN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Read the count maps</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s2">&quot;lens_maps&quot;</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="s2">&quot;maps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
            <span class="n">nbin_lens</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;nbin_lens&quot;</span><span class="p">]</span>
            <span class="n">ngal_maps</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">read_map</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;weighted_ngal_</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin_lens</span><span class="p">)]</span>

        <span class="c1"># Convert count maps into density maps</span>
        <span class="n">density_maps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ng</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ngal_maps</span><span class="p">):</span>
            <span class="n">mask_copy</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mask_copy</span><span class="p">[</span><span class="n">ng</span> <span class="o">==</span> <span class="n">healpy</span><span class="o">.</span><span class="n">UNSEEN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ng</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ng</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">ng</span><span class="p">[</span><span class="n">ng</span> <span class="o">==</span> <span class="n">healpy</span><span class="o">.</span><span class="n">UNSEEN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Convert the number count maps to overdensity maps.</span>
            <span class="c1"># First compute the overall mean object count per bin.</span>
            <span class="c1"># mean clustering galaxies per pixel in this map</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">ng</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">mask_copy</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean number density in bin </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">mu</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># and then use that to convert to overdensity</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">ng</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">mu</span>
            <span class="c1"># remove nans</span>
            <span class="n">d</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">density_maps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="c1"># write output</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="s2">&quot;density_maps&quot;</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># create group and save metadata there too.</span>
            <span class="n">f</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;maps&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">file</span><span class="p">[</span><span class="s2">&quot;maps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
            <span class="c1"># save each density map</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rho</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">density_maps</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write_map</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;delta_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">rho</span><span class="p">[</span><span class="n">pix</span><span class="p">],</span> <span class="n">meta</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, DESC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>