<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>txpipe.psf_diagnostics &mdash; TXPipe  documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> TXPipe
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">TXPipe Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running.html">Running a pipeline:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stages.html">Stages implemented in TX-Pipe:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../submodules.html">Submodules for TXPipe</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">TXPipe</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>txpipe.psf_diagnostics</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for txpipe.psf_diagnostics</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">.base_stage</span> <span class="kn">import</span> <span class="n">PipelineStage</span>
<span class="kn">from</span> <span class="nn">.data_types</span> <span class="kn">import</span> <span class="n">Directory</span><span class="p">,</span> <span class="n">ShearCatalog</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">,</span> <span class="n">PNGFile</span><span class="p">,</span> <span class="n">TomographyCatalog</span><span class="p">,</span> <span class="n">RandomsCatalog</span><span class="p">,</span> <span class="n">YamlFile</span>
<span class="kn">from</span> <span class="nn">parallel_statistics</span> <span class="kn">import</span> <span class="n">ParallelHistogram</span><span class="p">,</span> <span class="n">ParallelMeanVariance</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.utils.calibration_tools</span> <span class="kn">import</span> <span class="n">read_shear_catalog_type</span>
<span class="kn">from</span> <span class="nn">.utils.calibration_tools</span> <span class="kn">import</span> <span class="n">apply_metacal_response</span><span class="p">,</span> <span class="n">apply_lensfit_calibration</span>
<span class="kn">from</span> <span class="nn">.plotting</span> <span class="kn">import</span> <span class="n">manual_step_histogram</span>

<span class="n">STAR_PSF_USED</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">STAR_PSF_RESERVED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">STAR_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="n">STAR_PSF_USED</span><span class="p">,</span> <span class="n">STAR_PSF_RESERVED</span><span class="p">]</span>
<span class="n">STAR_TYPE_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PSF-used&#39;</span><span class="p">,</span> <span class="s1">&#39;PSF-reserved&#39;</span><span class="p">]</span>
<span class="n">STAR_COLORS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="TXPSFDiagnostics"><a class="viewcode-back" href="../../psf_diagnostics.html#txpipe.psf_diagnostics.TXPSFDiagnostics">[docs]</a><span class="k">class</span> <span class="nc">TXPSFDiagnostics</span><span class="p">(</span><span class="n">PipelineStage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;TXPSFDiagnostics&#39;</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;star_catalog&#39;</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;e1_psf_residual_hist&#39;</span><span class="p">,</span> <span class="n">PNGFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;e2_psf_residual_hist&#39;</span><span class="p">,</span> <span class="n">PNGFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;T_frac_psf_residual_hist&#39;</span><span class="p">,</span> <span class="n">PNGFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;star_psf_stats&#39;</span><span class="p">,</span> <span class="n">YamlFile</span><span class="p">),</span>

    <span class="p">]</span>
    <span class="n">config_options</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># PSF tests</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>

        <span class="c1"># Make plotters - in each case we supply the function to make</span>
        <span class="c1"># the thing we want to histogram, the name, label, and range</span>
        <span class="n">plotters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_histogram</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;measured_e1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;model_e1&#39;</span><span class="p">]),</span>
                <span class="s1">&#39;e1_psf_residual&#39;</span><span class="p">,</span>
                <span class="s1">&#39;$e_</span><span class="si">{1}</span><span class="s1">-e_{1,psf}$&#39;</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">51</span><span class="p">),</span>
                <span class="p">),</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">plot_histogram</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;measured_e2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;model_e2&#39;</span><span class="p">]),</span>
                <span class="s1">&#39;e2_psf_residual&#39;</span><span class="p">,</span>
                <span class="s1">&#39;$e_</span><span class="si">{2}</span><span class="s1">-e_{2,psf}$&#39;</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">51</span><span class="p">),</span>
                <span class="p">),</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">plot_histogram</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;measured_T&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;model_T&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;measured_T&#39;</span><span class="p">],</span>
                <span class="s1">&#39;T_frac_psf_residual&#39;</span><span class="p">,</span>
                <span class="s1">&#39;$(T-T</span><span class="si">{psf}</span><span class="s1">)/T</span><span class="si">{psf}</span><span class="s1">$&#39;</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">51</span><span class="p">),</span>
                <span class="p">),</span>

        <span class="p">]</span>

        <span class="c1"># Start off each of the plotters.  This will make them all run up to the</span>
        <span class="c1"># first yield statement, then pause and wait for the first chunk of data</span>
        <span class="k">for</span> <span class="n">plotter</span> <span class="ow">in</span> <span class="n">plotters</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">plotter</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Create an iterator for reading through the input data.</span>
        <span class="c1"># This method automatically splits up data among the processes,</span>
        <span class="c1"># so the plotters should handle this.</span>
        <span class="n">chunk_rows</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="n">star_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;measured_e1&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;model_e1&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;measured_e2&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;model_e2&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;measured_T&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;model_T&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;calib_psf_used&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;calib_psf_reserved&#39;</span><span class="p">,</span>
                     <span class="p">]</span>
        <span class="n">iter_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterate_hdf</span><span class="p">(</span><span class="s1">&#39;star_catalog&#39;</span><span class="p">,</span><span class="s1">&#39;stars&#39;</span><span class="p">,</span><span class="n">star_cols</span><span class="p">,</span><span class="n">chunk_rows</span><span class="p">)</span>

        <span class="c1"># Now loop through each chunk of input data, one at a time.</span>
        <span class="c1"># Each time we get a new segment of data, which goes to all the plotters</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">data</span><span class="p">),</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">iter_star</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read data </span><span class="si">{start}</span><span class="s2"> - </span><span class="si">{end}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;star_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_star_type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># This causes each data = yield statement in each plotter to</span>
            <span class="c1"># be given this data chunk as the variable data.</span>
            <span class="c1">#data.update(data2)</span>
            <span class="c1">#data.update(data3)</span>
            <span class="k">for</span> <span class="n">plotter</span> <span class="ow">in</span> <span class="n">plotters</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Tell all the plotters to finish, collect together results from the different</span>
        <span class="c1"># processors, and make their final plots.  Plotters need to respond</span>
        <span class="c1"># to the None input and</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">plotter</span> <span class="ow">in</span> <span class="n">plotters</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># This feels like some cruel abuse because I don&#39;t</span>
                <span class="c1"># really understand how co-routines should be used.</span>
                <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># save all counts, means, and sigmas to yaml file</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="s2">&quot;star_psf_stats&quot;</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_histogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">output_name</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">edges</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting </span><span class="si">{output_name}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">counters</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span><span class="n">ParallelHistogram</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">}</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">ParallelMeanVariance</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">STAR_TYPES</span><span class="p">))</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">yield</span>

            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># Get the specific quantity to plot</span>
            <span class="c1"># from the full data set</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;star_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span>
                <span class="c1"># build up histogram</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                <span class="n">counters</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="c1"># Also record data for mean and variance calculation</span>
                <span class="c1"># There are some NaNs in here which are presumably</span>
                <span class="c1"># not propagated to PSF estimation anyway</span>
                <span class="n">stats</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">d</span><span class="p">)])</span>

        <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">counters</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="n">output_name</span> <span class="o">+</span> <span class="s2">&quot;_hist&quot;</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">STAR_TYPES</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">manual_step_histogram</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span>
                                  <span class="n">counts</span><span class="p">[</span><span class="n">s</span><span class="p">],</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">STAR_COLORS</span><span class="p">[</span><span class="n">s</span><span class="p">],</span>
                                  <span class="n">label</span><span class="o">=</span><span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$N_</span><span class="si">{stars}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">n</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma2</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{output_name}</span><span class="s1">_</span><span class="si">{name}</span><span class="s1">_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
            <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{output_name}</span><span class="s1">_</span><span class="si">{name}</span><span class="s1">_mu&#39;</span><span class="p">]</span> <span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
            <span class="n">results</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{output_name}</span><span class="s1">_</span><span class="si">{name}</span><span class="s1">_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sigma2</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="TXRoweStatistics"><a class="viewcode-back" href="../../psf_diagnostics.html#txpipe.psf_diagnostics.TXRoweStatistics">[docs]</a><span class="k">class</span> <span class="nc">TXRoweStatistics</span><span class="p">(</span><span class="n">PipelineStage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    People sometimes think that these statistics are called the Rho statistics,</span>
<span class="sd">    because we usually use that letter for them.  Not so.  They are named after</span>
<span class="sd">    the wonderfully incorrigible rogue Barney Rowe, now sadly lost to high finance,</span>
<span class="sd">    who presented the first two of them in MNRAS 404, 350 (2010).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;TXRoweStatistics&#39;</span>

    <span class="n">inputs</span> <span class="o">=</span><span class="p">[(</span><span class="s1">&#39;star_catalog&#39;</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">)]</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;rowe134&#39;</span><span class="p">,</span> <span class="n">PNGFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;rowe25&#39;</span><span class="p">,</span> <span class="n">PNGFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;rowe_stats&#39;</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">config_options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;min_sep&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;max_sep&#39;</span><span class="p">:</span><span class="mf">250.0</span><span class="p">,</span>
        <span class="s1">&#39;nbins&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span>
        <span class="s1">&#39;bin_slop&#39;</span><span class="p">:</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="s1">&#39;sep_units&#39;</span><span class="p">:</span><span class="s1">&#39;arcmin&#39;</span><span class="p">,</span>
        <span class="s1">&#39;psf_size_units&#39;</span><span class="p">:</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">treecorr</span>
        <span class="kn">import</span> <span class="nn">h5py</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>

        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">e_psf</span><span class="p">,</span> <span class="n">de_psf</span><span class="p">,</span> <span class="n">T_f</span><span class="p">,</span> <span class="n">star_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_stars</span><span class="p">()</span>

        <span class="n">rowe_stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">star_type</span> <span class="o">==</span> <span class="n">t</span>
            <span class="n">rowe_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rowe</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">de_psf</span><span class="p">,</span>       <span class="n">de_psf</span><span class="p">)</span>
            <span class="n">rowe_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rowe</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">e_psf</span><span class="p">,</span>        <span class="n">de_psf</span><span class="p">)</span>
            <span class="n">rowe_stats</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rowe</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">e_psf</span><span class="o">*</span><span class="n">T_f</span><span class="p">,</span> <span class="n">e_psf</span><span class="o">*</span><span class="n">T_f</span><span class="p">)</span>
            <span class="n">rowe_stats</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rowe</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">de_psf</span><span class="p">,</span>    <span class="n">e_psf</span><span class="o">*</span><span class="n">T_f</span><span class="p">)</span>
            <span class="n">rowe_stats</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rowe</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">e_psf</span><span class="p">,</span>     <span class="n">e_psf</span><span class="o">*</span><span class="n">T_f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_stats</span><span class="p">(</span><span class="n">rowe_stats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rowe_plots</span><span class="p">(</span><span class="n">rowe_stats</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">load_stars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s1">&#39;star_catalog&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][:]</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][:]</span>
            <span class="n">e1</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;measured_e1&#39;</span><span class="p">][:]</span>
            <span class="n">e2</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;measured_e2&#39;</span><span class="p">][:]</span>
            <span class="n">de1</span> <span class="o">=</span> <span class="n">e1</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;model_e1&#39;</span><span class="p">][:]</span>
            <span class="n">de2</span> <span class="o">=</span> <span class="n">e2</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;model_e2&#39;</span><span class="p">][:]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;psf_size_units&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;T&#39;</span><span class="p">:</span>
                <span class="n">T_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;measured_T&#39;</span><span class="p">][:]</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;model_T&#39;</span><span class="p">][:])</span> <span class="o">/</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;measured_T&#39;</span><span class="p">][:]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;psf_size_units&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;sigma&#39;</span><span class="p">:</span>
                <span class="n">T_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;measured_T&#39;</span><span class="p">][:]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;model_T&#39;</span><span class="p">][:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;measured_T&#39;</span><span class="p">][:]</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">e_psf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">))</span>
            <span class="n">de_psf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">de1</span><span class="p">,</span> <span class="n">de2</span><span class="p">))</span>

            <span class="n">star_type</span> <span class="o">=</span> <span class="n">load_star_type</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">e_psf</span><span class="p">,</span> <span class="n">de_psf</span><span class="p">,</span> <span class="n">T_frac</span><span class="p">,</span> <span class="n">star_type</span>

    <span class="k">def</span> <span class="nf">compute_rowe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">):</span>
        <span class="c1"># select a subset of the stars</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">q1</span><span class="p">[:,</span> <span class="n">s</span><span class="p">]</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">q2</span><span class="p">[:,</span> <span class="n">s</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing Rowe statistic rho_</span><span class="si">{i}</span><span class="s2"> from </span><span class="si">{n}</span><span class="s2"> objects&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">treecorr</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">GGCorrelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">cat1</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">Catalog</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">g1</span><span class="o">=</span><span class="n">q1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">g2</span><span class="o">=</span><span class="n">q1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ra_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">dec_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">cat2</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">Catalog</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">g1</span><span class="o">=</span><span class="n">q2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">g2</span><span class="o">=</span><span class="n">q2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ra_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">dec_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">corr</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">corr</span><span class="o">.</span><span class="n">meanr</span><span class="p">,</span> <span class="n">corr</span><span class="o">.</span><span class="n">xip</span><span class="p">,</span> <span class="n">corr</span><span class="o">.</span><span class="n">varxip</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="k">def</span> <span class="nf">rowe_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rowe_stats</span><span class="p">):</span>
        <span class="c1"># First plot - stats 1,3,4</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">matplotlib.transforms</span> <span class="k">as</span> <span class="nn">mtrans</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="s1">&#39;rowe134&#39;</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">STAR_TYPES</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">STAR_TYPES</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>


            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]):</span>
                <span class="n">theta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rowe_stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="n">mtrans</span><span class="o">.</span><span class="n">offset_copy</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="mf">0.05</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;inches&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xi</span><span class="p">),</span> <span class="n">err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s1">&#39;$\rho_</span><span class="si">{i}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">tr</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">2e-05</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mf">1e-07</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">245</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\theta$&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\xi_+(\theta)$&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="s1">&#39;rowe25&#39;</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">STAR_TYPES</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">STAR_TYPES</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">]):</span>
                <span class="n">theta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rowe_stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="n">mtrans</span><span class="o">.</span><span class="n">offset_copy</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">j</span><span class="o">-</span><span class="mf">0.025</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;inches&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xi</span><span class="p">),</span> <span class="n">err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s1">&#39;$\rho_</span><span class="si">{i}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">tr</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">2e-05</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mf">1e-07</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">245</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\theta$&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\xi_+(\theta)$&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rowe_stats</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="s1">&#39;rowe_stats&#39;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;rowe_statistics&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
                <span class="n">theta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rowe_stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rowe_</span><span class="si">{i}</span><span class="s1">_</span><span class="si">{name}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;xi_plus&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">xi</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;xi_err&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="TXStarShearTests"><a class="viewcode-back" href="../../psf_diagnostics.html#txpipe.psf_diagnostics.TXStarShearTests">[docs]</a><span class="k">class</span> <span class="nc">TXStarShearTests</span><span class="p">(</span><span class="n">PipelineStage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Star cross galaxy and star autocorrelation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;TXGalaxyStarShear&#39;</span>

    <span class="n">inputs</span> <span class="o">=</span><span class="p">[(</span><span class="s1">&#39;shear_catalog&#39;</span><span class="p">,</span> <span class="n">ShearCatalog</span><span class="p">),(</span><span class="s1">&#39;star_catalog&#39;</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;shear_tomography_catalog&#39;</span><span class="p">,</span> <span class="n">TomographyCatalog</span><span class="p">)]</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;star_shear_test&#39;</span><span class="p">,</span> <span class="n">PNGFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;star_star_test&#39;</span><span class="p">,</span> <span class="n">PNGFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;star_shear_stats&#39;</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">config_options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;min_sep&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;max_sep&#39;</span><span class="p">:</span><span class="mf">250.0</span><span class="p">,</span>
        <span class="s1">&#39;nbins&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span>
        <span class="s1">&#39;bin_slop&#39;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="s1">&#39;sep_units&#39;</span><span class="p">:</span><span class="s1">&#39;arcmin&#39;</span><span class="p">,</span>
        <span class="s1">&#39;psf_size_units&#39;</span><span class="p">:</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span>
        <span class="s1">&#39;shear_catalog_type&#39;</span><span class="p">:</span><span class="s1">&#39;metacal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;flip_g2&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">treecorr</span>
        <span class="kn">import</span> <span class="nn">h5py</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>

        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">e_psf</span><span class="p">,</span> <span class="n">de_psf</span><span class="p">,</span> <span class="n">star_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_stars</span><span class="p">()</span>
        <span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec_gal</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_galaxies</span><span class="p">()</span>

        <span class="c1">#only use reserved stars for this statistics</span>
        <span class="n">galaxy_star_stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">star_star_stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">star_type</span> <span class="o">==</span> <span class="n">t</span>
            <span class="n">galaxy_star_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_galaxy_star</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">e_psf</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec_gal</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
            <span class="n">galaxy_star_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_galaxy_star</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">de_psf</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec_gal</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
            <span class="n">star_star_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_star_star</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">e_psf</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec_gal</span><span class="p">,</span> <span class="n">e_psf</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
            <span class="n">star_star_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_star_star</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">de_psf</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec_gal</span><span class="p">,</span> <span class="n">de_psf</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_stats</span><span class="p">(</span><span class="n">galaxy_star_stats</span><span class="p">,</span><span class="n">star_star_stats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galaxy_star_plots</span><span class="p">(</span><span class="n">galaxy_star_stats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">star_star_plots</span><span class="p">(</span><span class="n">star_star_stats</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">load_stars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s1">&#39;star_catalog&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][:]</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][:]</span>
            <span class="n">e1</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;measured_e1&#39;</span><span class="p">][:]</span>
            <span class="n">e2</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;measured_e2&#39;</span><span class="p">][:]</span>
            <span class="n">de1</span> <span class="o">=</span> <span class="n">e1</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;model_e1&#39;</span><span class="p">][:]</span>
            <span class="n">de2</span> <span class="o">=</span> <span class="n">e2</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;model_e2&#39;</span><span class="p">][:]</span>

            <span class="n">e_psf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">))</span>
            <span class="n">de_psf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">de1</span><span class="p">,</span> <span class="n">de2</span><span class="p">))</span>

            <span class="n">star_type</span> <span class="o">=</span> <span class="n">load_star_type</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">e_psf</span><span class="p">,</span> <span class="n">de_psf</span><span class="p">,</span> <span class="n">star_type</span>

    <span class="k">def</span> <span class="nf">load_galaxies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Columns we need from the shear catalog</span>
        <span class="c1"># TODO: not sure of an application where we would want to use true shear but can be added</span>
        <span class="n">read_shear_catalog_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># load tomography data</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s1">&#39;shear_tomography_catalog&#39;</span><span class="p">)</span>
        <span class="n">source_bin</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;tomography/source_bin&#39;</span><span class="p">][:]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">source_bin</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Only use the sources that pass the fiducial cuts</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;shear_catalog_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;metacal&#39;</span><span class="p">:</span>
            <span class="n">R_total_2d</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;metacal_response/R_total_2d&#39;</span><span class="p">][:]</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s1">&#39;shear_catalog&#39;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;shear&#39;</span><span class="p">]</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][:][</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][:][</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;shear_catalog_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;metacal&#39;</span><span class="p">:</span>
            <span class="n">g1</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;mcal_g1&#39;</span><span class="p">][:][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">g2</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;mcal_g2&#39;</span><span class="p">][:][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">][:][</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g1</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">][:][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">g2</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;g2&#39;</span><span class="p">][:][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">][:][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">sigma_e</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;sigma_e&#39;</span><span class="p">][:][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">][:][</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;flip_g2&#39;</span><span class="p">]:</span>
            <span class="n">g2</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;shear_catalog_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;metacal&#39;</span><span class="p">:</span>
            <span class="c1"># We use S=0 here because we have already included it in R_total</span>
            <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">apply_metacal_response</span><span class="p">(</span><span class="n">R_total_2d</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;shear_catalog_type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;lensfit&#39;</span><span class="p">:</span>
            <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">apply_lensfit_calibration</span><span class="p">(</span><span class="n">g1</span> <span class="o">=</span> <span class="n">g1</span><span class="p">,</span><span class="n">g2</span> <span class="o">=</span> <span class="n">g2</span><span class="p">,</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span><span class="p">,</span><span class="n">sigma_e</span> <span class="o">=</span> <span class="n">sigma_e</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shear calibration type not recognized.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">weight</span>

    <span class="k">def</span> <span class="nf">compute_galaxy_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec_gal</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
        <span class="c1"># select the star type</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="n">s</span><span class="p">]</span> <span class="c1"># PSF quantity, either ellipticity or residual</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra_gal</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing galaxy-cross-star statistic from </span><span class="si">{n}</span><span class="s2"> stars and </span><span class="si">{i}</span><span class="s2"> galaxies&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">treecorr</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">GGCorrelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">cat1</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">Catalog</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">g1</span><span class="o">=</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">g2</span><span class="o">=</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ra_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">dec_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">cat2</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">Catalog</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec_gal</span><span class="p">,</span> <span class="n">g1</span><span class="o">=</span><span class="n">g2</span><span class="p">,</span> <span class="n">g2</span><span class="o">=</span><span class="n">g2</span><span class="p">,</span> <span class="n">ra_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">dec_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">corr</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">corr</span><span class="o">.</span><span class="n">meanr</span><span class="p">,</span> <span class="n">corr</span><span class="o">.</span><span class="n">xip</span><span class="p">,</span> <span class="n">corr</span><span class="o">.</span><span class="n">varxip</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="k">def</span> <span class="nf">compute_star_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec_gal</span><span class="p">,</span> <span class="n">q2</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
        <span class="c1"># select the star type</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">q1</span><span class="p">[:,</span> <span class="n">s</span><span class="p">]</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">q2</span><span class="p">[:,</span> <span class="n">s</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra_gal</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing galaxy-cross-star statistic from </span><span class="si">{n}</span><span class="s2"> stars and </span><span class="si">{i}</span><span class="s2"> galaxies&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">treecorr</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">GGCorrelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">cat1</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">Catalog</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">g1</span><span class="o">=</span><span class="n">q1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">g2</span><span class="o">=</span><span class="n">q1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ra_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">dec_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">cat2</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">Catalog</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">g1</span><span class="o">=</span><span class="n">q2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">g2</span><span class="o">=</span><span class="n">q2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ra_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">dec_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">corr</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">corr</span><span class="o">.</span><span class="n">meanr</span><span class="p">,</span> <span class="n">corr</span><span class="o">.</span><span class="n">xip</span><span class="p">,</span> <span class="n">corr</span><span class="o">.</span><span class="n">varxip</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="k">def</span> <span class="nf">galaxy_star_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">galaxy_star_stats</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">matplotlib.transforms</span> <span class="k">as</span> <span class="nn">mtrans</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="s1">&#39;star_shear_test&#39;</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">STAR_TYPES</span><span class="p">)))</span>
        <span class="n">TEST_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;shear&#39;</span><span class="p">,</span><span class="s1">&#39;residual&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">STAR_TYPES</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">theta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">galaxy_star_stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="n">mtrans</span><span class="o">.</span><span class="n">offset_copy</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">j</span><span class="o">-</span><span class="mf">0.025</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;inches&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xi</span><span class="p">),</span> <span class="n">err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;galaxy cross star </span><span class="si">{TEST_TYPES[i-1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">tr</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\theta$&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\xi_+(\theta)$&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">star_star_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">star_star_stats</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">matplotlib.transforms</span> <span class="k">as</span> <span class="nn">mtrans</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="s1">&#39;star_star_test&#39;</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">STAR_TYPES</span><span class="p">)))</span>
        <span class="n">TEST_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;shear&#39;</span><span class="p">,</span><span class="s1">&#39;residual&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">STAR_TYPES</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">theta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">star_star_stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="n">mtrans</span><span class="o">.</span><span class="n">offset_copy</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">j</span><span class="o">-</span><span class="mf">0.025</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;inches&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xi</span><span class="p">),</span> <span class="n">err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;star cross star </span><span class="si">{TEST_TYPES[i-1]}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">tr</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\theta$&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\xi_+(\theta)$&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">galaxy_star_stats</span><span class="p">,</span> <span class="n">star_star_stats</span><span class="p">):</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="s1">&#39;star_shear_stats&#39;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;star_cross_galaxy&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
                <span class="n">theta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">galaxy_star_stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;star_cross_galaxy_</span><span class="si">{i}</span><span class="s1">_</span><span class="si">{name}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;xi_plus&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">xi</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;xi_err&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;star_cross_star&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
                <span class="n">theta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">star_star_stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;star_cross_star_</span><span class="si">{i}</span><span class="s1">_</span><span class="si">{name}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;xi_plus&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">xi</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;xi_err&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>




<div class="viewcode-block" id="TXStarDensityTests"><a class="viewcode-back" href="../../psf_diagnostics.html#txpipe.psf_diagnostics.TXStarDensityTests">[docs]</a><span class="k">class</span> <span class="nc">TXStarDensityTests</span><span class="p">(</span><span class="n">PipelineStage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Star cross galaxy and star autocorrelation density stats.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;TXGalaxyStarDensity&#39;</span>

    <span class="n">inputs</span> <span class="o">=</span><span class="p">[(</span><span class="s1">&#39;shear_catalog&#39;</span><span class="p">,</span> <span class="n">ShearCatalog</span><span class="p">),(</span><span class="s1">&#39;star_catalog&#39;</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;shear_tomography_catalog&#39;</span><span class="p">,</span> <span class="n">TomographyCatalog</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;random_cats&#39;</span><span class="p">,</span> <span class="n">RandomsCatalog</span><span class="p">)]</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;star_density_test&#39;</span><span class="p">,</span> <span class="n">PNGFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;star_density_stats&#39;</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">config_options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;min_sep&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;max_sep&#39;</span><span class="p">:</span><span class="mf">250.0</span><span class="p">,</span>
        <span class="s1">&#39;nbins&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span>
        <span class="s1">&#39;bin_slop&#39;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="s1">&#39;sep_units&#39;</span><span class="p">:</span><span class="s1">&#39;arcmin&#39;</span><span class="p">,</span>
        <span class="s1">&#39;psf_size_units&#39;</span><span class="p">:</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span>
        <span class="s1">&#39;flip_g2&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">treecorr</span>
        <span class="kn">import</span> <span class="nn">h5py</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>

        <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span>  <span class="n">star_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_stars</span><span class="p">()</span>
        <span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec_gal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_galaxies</span><span class="p">()</span>
        <span class="n">ra_random</span><span class="p">,</span> <span class="n">dec_random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_randoms</span><span class="p">()</span>

        <span class="n">galaxy_star_stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">star_type</span> <span class="o">==</span> <span class="n">t</span>
            <span class="n">galaxy_star_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_galaxy_star</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec_gal</span><span class="p">,</span> <span class="n">ra_random</span><span class="p">,</span> <span class="n">dec_random</span><span class="p">)</span>
            <span class="n">galaxy_star_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_star_star</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec_gal</span><span class="p">,</span> <span class="n">ra_random</span><span class="p">,</span> <span class="n">dec_random</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_stats</span><span class="p">(</span><span class="n">galaxy_star_stats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galaxy_star_plots</span><span class="p">(</span><span class="n">galaxy_star_stats</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">load_stars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s1">&#39;star_catalog&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][:]</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][:]</span>

            <span class="n">star_type</span> <span class="o">=</span> <span class="n">load_star_type</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">star_type</span>

    <span class="k">def</span> <span class="nf">load_randoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s1">&#39;random_cats&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;randoms&#39;</span><span class="p">]</span>
            <span class="n">ra_random</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][:]</span>
            <span class="n">dec_random</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][:]</span>
        <span class="k">return</span> <span class="n">ra_random</span><span class="p">,</span> <span class="n">dec_random</span>

    <span class="k">def</span> <span class="nf">load_galaxies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Columns we need from the shear catalog</span>
        <span class="c1"># TODO: not sure of an application where we would want to use true shear but can be added</span>
        <span class="n">read_shear_catalog_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># load tomography data</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s1">&#39;shear_tomography_catalog&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">source_bin</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;tomography/source_bin&#39;</span><span class="p">][:]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">source_bin</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Only use the sources that pass the fiducial cuts</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s1">&#39;shear_catalog&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;shear&#39;</span><span class="p">]</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">][:][</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">][:][</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span>

    <span class="k">def</span> <span class="nf">compute_galaxy_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec_gal</span><span class="p">,</span> <span class="n">ra_random</span><span class="p">,</span> <span class="n">dec_random</span><span class="p">):</span>
        <span class="c1"># select the star type</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra_gal</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing galaxy-cross-star statistic from </span><span class="si">{n}</span><span class="s2"> stars and </span><span class="si">{i}</span><span class="s2"> galaxies&quot;</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">treecorr</span>

        <span class="n">rancat</span>  <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">Catalog</span><span class="p">(</span>
                <span class="n">ra</span><span class="o">=</span><span class="n">ra_random</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec_random</span><span class="p">,</span>
                <span class="n">ra_units</span><span class="o">=</span><span class="s1">&#39;degree&#39;</span><span class="p">,</span> <span class="n">dec_units</span><span class="o">=</span><span class="s1">&#39;degree&#39;</span><span class="p">)</span>

        <span class="n">cat1</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">Catalog</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">ra_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">dec_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">cat2</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">Catalog</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec_gal</span><span class="p">,</span> <span class="n">ra_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">dec_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>

        <span class="n">nn</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">NNCorrelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">NNCorrelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">nr</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">NNCorrelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">NNCorrelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="n">nn</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span>    <span class="n">cat2</span><span class="p">)</span>
        <span class="n">nr</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span>    <span class="n">rancat</span><span class="p">)</span>
        <span class="n">rn</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">rancat</span><span class="p">,</span> <span class="n">cat2</span><span class="p">)</span>
        <span class="n">rr</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">rancat</span><span class="p">,</span> <span class="n">rancat</span><span class="p">)</span>

        <span class="n">nn</span><span class="o">.</span><span class="n">calculateXi</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">nr</span><span class="p">,</span> <span class="n">rd</span><span class="o">=</span><span class="n">rn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">meanr</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">varxi</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="k">def</span> <span class="nf">compute_star_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec_gal</span><span class="p">,</span> <span class="n">ra_random</span><span class="p">,</span> <span class="n">dec_random</span><span class="p">):</span>
        <span class="c1"># select the star type</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra_gal</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing galaxy-cross-star statistic from </span><span class="si">{n}</span><span class="s2"> stars and </span><span class="si">{i}</span><span class="s2"> galaxies&quot;</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">treecorr</span>

        <span class="n">rancat</span>  <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">Catalog</span><span class="p">(</span>
                <span class="n">ra</span><span class="o">=</span><span class="n">ra_random</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec_random</span><span class="p">,</span>
                <span class="n">ra_units</span><span class="o">=</span><span class="s1">&#39;degree&#39;</span><span class="p">,</span> <span class="n">dec_units</span><span class="o">=</span><span class="s1">&#39;degree&#39;</span><span class="p">)</span>

        <span class="n">cat1</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">Catalog</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">ra_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">dec_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">cat2</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">Catalog</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ra_gal</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec_gal</span><span class="p">,</span> <span class="n">ra_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">dec_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>

        <span class="n">nn</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">NNCorrelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">NNCorrelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">nr</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">NNCorrelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">treecorr</span><span class="o">.</span><span class="n">NNCorrelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="n">nn</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span>    <span class="n">cat1</span><span class="p">)</span>
        <span class="n">nr</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">cat1</span><span class="p">,</span>    <span class="n">rancat</span><span class="p">)</span>
        <span class="n">rn</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">rancat</span><span class="p">,</span> <span class="n">cat1</span><span class="p">)</span>
        <span class="n">rr</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">rancat</span><span class="p">,</span> <span class="n">rancat</span><span class="p">)</span>

        <span class="n">nn</span><span class="o">.</span><span class="n">calculateXi</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">dr</span><span class="o">=</span><span class="n">nr</span><span class="p">,</span> <span class="n">rd</span><span class="o">=</span><span class="n">rn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">meanr</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">xi</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">varxi</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="k">def</span> <span class="nf">galaxy_star_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">galaxy_star_stats</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">matplotlib.transforms</span> <span class="k">as</span> <span class="nn">mtrans</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="s1">&#39;star_density_test&#39;</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">STAR_TYPES</span><span class="p">)))</span>
        <span class="n">TEST_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;star cross galaxy&#39;</span><span class="p">,</span><span class="s1">&#39;star cross star&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">STAR_TYPES</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">theta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">galaxy_star_stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="n">mtrans</span><span class="o">.</span><span class="n">offset_copy</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">j</span><span class="o">-</span><span class="mf">0.025</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;inches&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xi</span><span class="p">),</span> <span class="n">err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{TEST_TYPES[i-1]}</span><span class="s1"> density stats&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">tr</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\theta$&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\xi_+(\theta)$&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">galaxy_star_stats</span><span class="p">):</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="s1">&#39;star_density_stats&#39;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;star_density&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
                <span class="n">theta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">galaxy_star_stats</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;star_density_</span><span class="si">{i}</span><span class="s1">_</span><span class="si">{name}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;xi_plus&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">xi</span><span class="p">)</span>
                <span class="n">h</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;xi_err&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">err</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="TXBrighterFatterPlot"><a class="viewcode-back" href="../../psf_diagnostics.html#txpipe.psf_diagnostics.TXBrighterFatterPlot">[docs]</a><span class="k">class</span> <span class="nc">TXBrighterFatterPlot</span><span class="p">(</span><span class="n">PipelineStage</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;TXBrighterFatterPlot&#39;</span>

    <span class="n">inputs</span> <span class="o">=</span><span class="p">[(</span><span class="s1">&#39;star_catalog&#39;</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">)]</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;brighter_fatter_plot&#39;</span><span class="p">,</span> <span class="n">PNGFile</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;brighter_fatter_data&#39;</span><span class="p">,</span> <span class="n">HDFFile</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="n">config_options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;band&#39;</span><span class="p">:</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nbin&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s1">&#39;mmin&#39;</span><span class="p">:</span> <span class="mf">18.5</span><span class="p">,</span>
        <span class="s1">&#39;mmax&#39;</span><span class="p">:</span> <span class="mf">23.5</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">h5py</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_stars</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">STAR_TYPES</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;star_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span>
            <span class="n">data_s</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">results</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_binned_stats</span><span class="p">(</span><span class="n">data_s</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_stats</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_plots</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_stars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_input</span><span class="p">(</span><span class="s1">&#39;star_catalog&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span>

            <span class="n">band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mag_</span><span class="si">{band}</span><span class="s1">&#39;</span><span class="p">][:]</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;delta_e1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;measured_e1&#39;</span><span class="p">][:]</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;model_e1&#39;</span><span class="p">][:]</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;delta_e2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;measured_e2&#39;</span><span class="p">][:]</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;model_e2&#39;</span><span class="p">][:]</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;delta_T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;measured_T&#39;</span><span class="p">][:]</span> <span class="o">-</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;model_T&#39;</span><span class="p">][:]</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;star_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_star_type</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">compute_binned_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Which band this corresponds to depends on the</span>
        <span class="c1"># configuration option chosen</span>
        <span class="n">mag</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span>
        <span class="n">mmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mmin&#39;</span><span class="p">]</span>
        <span class="n">mmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mmax&#39;</span><span class="p">]</span>
        <span class="n">nbin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nbin&#39;</span><span class="p">]</span>
        <span class="c1"># bin edges in magnitude</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mmin</span><span class="p">,</span> <span class="n">mmax</span><span class="p">,</span> <span class="n">nbin</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">mag</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span>

        <span class="c1"># Space for all the output values to go in</span>
        <span class="n">dT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbin</span><span class="p">)</span>
        <span class="n">errT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbin</span><span class="p">)</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbin</span><span class="p">)</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbin</span><span class="p">)</span>
        <span class="n">err1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbin</span><span class="p">)</span>
        <span class="n">err2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbin</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbin</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin</span><span class="p">):</span>
            <span class="c1"># Select only objects where everything is finite, as well</span>
            <span class="c1"># as only thing in this tomographic bin</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">index</span><span class="o">==</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;delta_T&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;delta_e1&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;delta_e2&#39;</span><span class="p">])</span> <span class="p">)</span>
            <span class="c1"># x-value = mean mag</span>
            <span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="c1"># y values</span>
            <span class="n">dT_i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;delta_T&#39;</span><span class="p">][</span><span class="n">w</span><span class="p">]</span>
            <span class="n">e1_i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;delta_e1&#39;</span><span class="p">][</span><span class="n">w</span><span class="p">]</span>
            <span class="n">e2_i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;delta_e2&#39;</span><span class="p">][</span><span class="n">w</span><span class="p">]</span>
            <span class="c1"># Mean and error on mean of each of these quantities</span>
            <span class="n">dT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_i</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">errT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_i</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dT_i</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">e1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">e1_i</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">err1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">e1_i</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">e1_i</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">e2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">e2_i</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">err2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">e2_i</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">e2_i</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">dT</span><span class="p">,</span> <span class="n">errT</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">err1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">err2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">save_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">6</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="s1">&#39;brighter_fatter_plot&#39;</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">dT</span><span class="p">,</span> <span class="n">errT</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">err1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">err2</span> <span class="o">=</span> <span class="n">res</span>

            <span class="c1"># Top plot - classic BF size plot, the size residual as a function of</span>
            <span class="c1"># magnitude</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dT</span><span class="p">,</span> <span class="n">errT</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{band}</span><span class="s2">-band magnitude&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$T_\mathrm</span><span class="si">{PSF}</span><span class="s2"> - T_\mathrm</span><span class="si">{model}</span><span class="s2">$ ($\mathrm</span><span class="si">{arcsec}</span><span class="s2">^2$)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="c1"># Lower plot - the e1 and e2 residuals as a function of mag</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">err1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$e_1$&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">err2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;$e_2$&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$e_\mathrm</span><span class="si">{PSF}</span><span class="s2"> - e_\mathrm</span><span class="si">{model}</span><span class="s2">$&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{band}</span><span class="s2">-band magnitude&quot;</span><span class="p">)</span>
            <span class="c1"># May need to adjust this range</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="c1"># Save all the stats in results for later plotting</span>
        <span class="c1"># Save to standard HDF5 format.</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_output</span><span class="p">(</span><span class="s1">&#39;brighter_fatter_data&#39;</span><span class="p">)</span>
        <span class="n">g1</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;brighter_fatter&#39;</span><span class="p">)</span>
        <span class="n">g1</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dT</span><span class="p">,</span> <span class="n">errT</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">err1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">err2</span><span class="p">)</span> <span class="o">=</span> <span class="n">res</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">g1</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">STAR_TYPE_NAMES</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
            <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;mag&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;delta_T&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dT</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;delta_T_error&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">errT</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;delta_e1&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">e1</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;delta_e1_error&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">err1</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;delta_e2&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">e2</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;delta_e2_error&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">err2</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<span class="k">def</span> <span class="nf">load_star_type</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">used</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;calib_psf_used&#39;</span><span class="p">][:]</span>
    <span class="n">reserved</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;calib_psf_reserved&#39;</span><span class="p">][:]</span>

    <span class="n">star_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">used</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">star_type</span><span class="p">[</span><span class="n">used</span><span class="p">]</span> <span class="o">=</span> <span class="n">STAR_PSF_USED</span>
    <span class="n">star_type</span><span class="p">[</span><span class="n">reserved</span><span class="p">]</span> <span class="o">=</span> <span class="n">STAR_PSF_RESERVED</span>

    <span class="k">return</span> <span class="n">star_type</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, DESC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>